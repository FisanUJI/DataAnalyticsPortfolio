"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[69116],{137373:(e,t,i)=>{i.d(t,{S3:()=>l,U4:()=>o,Yn:()=>h,bH:()=>n,pe:()=>d,ul:()=>r});var a=i(777142),s=i(270350);let r=e=>`media-provider-tab-${e}`,o=e=>`media-provider-${e}`,n=e=>{if("image"===e.type)switch(e.data.provider){case"unsplash":return"unsplash";case"giphy":return"giphy";case"feature-attachment":case"uri":return"link";case"item-resource":return"upload";default:return}},l=(e,t)=>"error"!==e&&(t!==s.O2.Image||"photo"===e)&&(t!==s.O2.Video||"video"===e)&&(t!==s.O2.ImageOrVideo||"photo"===e||"video"===e),d=(e,t)=>{let i=new Set,a=e.concat(t),s=[];for(let e=0;e<a.length;e++){let t=a[e];i.has(t.id)||(s.push(t),i.add(t.id))}return s};function h(e,t,i){let r=[];switch(e){case s.O2.Image:r=[...a.gC,...t.SUPPORTED_CONVERTIBLE_IMAGE_MIME_TYPES];break;case s.O2.Image360:r=[...a.Wr];break;case s.O2.Audio:r=[...a.Ts,...t.SUPPORTED_CONVERTIBLE_AUDIO_MIME_TYPES];break;case s.O2.Video:r=[...a.ue,...t.SUPPORTED_CONVERTIBLE_VIDEO_MIME_TYPES];break;case s.O2.File:r=[...a.pp]}return r.reduce((e,t)=>i&&i.includes(t)?[...e]:[...e,t],[])}},148495:(e,t,i)=>{i.d(t,{CE:()=>r,sN:()=>o,uM:()=>n});var a=i(230658),s=i(142529);let r=e=>"expressmap"===e||"thematic-map-dataset"===e||"express-image-data"===e,o=(e,t,i)=>{let s=e&&("string"==typeof e.root||i===a.z.Collection||i===a.z.Theme)?n(e):n(),o=t&&("string"==typeof t.root||i===a.z.Collection||i===a.z.Theme)?n(t):n();return{itemResourcesToUnpublish:o.itemResources.filter(e=>-1===s.itemResources.findIndex(t=>t.id===e.id)),itemResourcesToPublish:s.itemResources.filter(e=>!!r(e.type)||-1===o.itemResources.findIndex(t=>t.id===e.id)),draftItemResources:s.itemResources,publishedItemResources:o.itemResources,relatedItems:s.itemRelationships.concat(o.itemRelationships)}},n=e=>{let t=[],i=[];return e&&Object.keys(e.resources??{}).forEach(a=>{let r=e.resources[a];"image"===r.type&&"item-resource"===r.data.provider?t.push({id:r.data.resourceId,type:"image"}):"image360"===r.type&&"item-resource"===r.data.provider?t.push({id:r.data.resourceId,type:"image360"}):"video"===r.type&&"item-resource"===r.data.provider?t.push({id:r.data.resourceId,type:"video"}):"audio"===r.type&&"item-resource"===r.data.provider?t.push({id:r.data.resourceId,type:"audio"}):"expressmap"===r.type&&l(r.data)?t.push({id:r.data.itemId,type:"expressmap"}):"thematic-map-dataset"===r.type?t.push({id:r.data.itemId,type:"thematic-map-dataset"}):"express-image-data"===r.type?t.push({id:r.data.itemId,type:"express-image-data"}):"file-item"===r.type&&"item-resource"===r.data.provider?t.push({id:r.data.resourceId,type:"file-item"}):"story-theme"===r.type&&r.data.themeItemId?i.push({type:s.wx,itemId:r.data.themeItemId}):"geo-data"===r.type&&"item-resource"===r.data.provider?t.push({id:r.data.resourceId,type:"geo-data"}):"json"===r.type&&"item-resource"===r.data.provider?t.push({id:r.data.resourceId,type:"json"}):"ai-metadata"===r.type&&"item-resource"===r.data.provider&&t.push({id:r.data.resourceId,type:"ai-metadata"})}),{itemResources:t,itemRelationships:i}},l=e=>void 0===e.provider&&!!e.itemId},213218:(e,t,i)=>{i.d(t,{D:()=>s});var a=i(284750);class s extends Error{constructor(e){super(),this.name="StoryBuilderError";let{type:t,itemType:i}=e;this.type=this.message=t,this.itemType=i;let{statusCode:s}=(0,a.P)(this.type);this.statusCode=s}}},226453:(e,t,i)=>{i.d(t,{i:()=>s,s:()=>a});let a={access:i(325247).uQ.PRIVATE,groups:[],isUnlisted:!1},s={title:"common.arcgis.visibility.selector.accessLevel.heading",description:"common.arcgis.sharing.selector.accessLevel.description"}},269116:(e,t,i)=>{i.d(t,{uB:()=>eL,YJ:()=>ek,Ay:()=>eU});var a=i(777011),s=i(342211),r=i(647682),o=i(54302),n=i(231879),l=i(462829),d=i(375603),h=i(611179),u=i(960642),c=i(989206),m=i(674772),p=i(230658),y=i(888308);let f=/screenshot-[A-Z]+-n-[A-Za-z0-9]{6}\.png/;var g=i(425233),S=i(142529);let D=async e=>{let{authManager:t,itemId:i,mode:a,relationships:s,isSMXItemInAGSM:o}=e,n={destinationItemId:i,authentication:t},l=[],d=(await (0,r.S9)({authentication:t,id:i,relationshipType:S.wx})).relatedItems.map(e=>e.id),h=s.reduce((e,t)=>t.type!==S.wx||d.includes(t.itemId)?e:e.concat(t),[]),u=[];d.forEach(e=>{s.find(t=>t.type===S.wx&&t.itemId===e)||u.push({itemId:e,type:S.wx})},[]),h.forEach(e=>{o&&"Theme2Story"===e.type||l.push((0,r.xg)({...n,originItemId:e.itemId,relationshipType:e.type}))}),u.forEach(e=>{o&&"Theme2Story"===e.type||l.push((0,r.y6)({...n,originItemId:e.itemId,relationshipType:e.type}))}),a===g.uB.DRAFT_SAVE||a===g.uB.DISCARDING_UNPUBLISHED_CHANGES?await Promise.allSettled(l):await Promise.all(l)};class b extends Error{constructor(e,t){super(t),this.resourceProperties=e}}var A=i(148495);let I=async e=>{let{authManager:t,config:i,fallbackThumbnailUrl:a,isDataLossAllowed:s,itemId:d,itemResourcesEditInfo:h}=e,u=await (0,r.Gq)(d,{authentication:t}),c=(0,o.Jc)({portalHost:i.PORTAL_HOST,itemDetails:u,fallbackUrl:a,shouldIgnoreDPR:!0,returnOriginalAspectRatio:!0,size:800}),m=await (0,n.vX)(c),{title:p,url:y="",byline:f}=u,g={version:"1.0",type:"rich",title:p,url:y,author_name:f,provider_name:`${i.PRODUCT_NAME}`,provider_url:new URL(y).origin,width:800,height:600,thumbnail_url:`${c}`,thumbnail_height:`${m.height}`,thumbnail_width:`${m.width}`,html:`<iframe src="${y}" width="800" height="600" scrolling="yes" frameborder="0" allowfullscreen></iframe>`,cache_age:86400},S=`<?xml version="1.0" encoding="utf-8" standalone="yes"?>
    <oembed>
      <version>1.0</version>
      <type>rich</type>
      <title>${p}</title>
      <url>${y}</url>
      <author_name>${f}</author_name>
      <provider_name>${i.PRODUCT_NAME}</provider_name>
      <provider_url>${new URL(y).origin}</provider_url>
      <width>800</width>
      <height>600</height>
      <thumbnail_url>${c}</thumbnail_url>
      <thumbnail_height>${m.height}</thumbnail_height>
      <thumbnail_width>${m.width}</thumbnail_width>
      <html><iframe src="${y}" width="800" height="600" scrolling="yes" frameborder="0" allowfullscreen="true"></iframe></html>
      <cache_age>86400</cache_age>
    </oembed>
    `;return await Promise.all([w({authManager:t,config:i,isDataLossAllowed:s,isPublished:!0,itemDetails:u,itemResourcesEditInfo:h,resourceName:"oembed.json",resource:(0,l.YX)(g)}),w({authManager:t,config:i,isDataLossAllowed:s,isPublished:!0,itemDetails:u,itemResourcesEditInfo:h,resourceName:"oembed.xml",resource:new Blob([S],{type:"text/xml"})})]),{xml:S,json:g}},w=async e=>{let t,i,a=e.authManager;if(!a)throw Error("no user session");let{id:o,owner:n}=e.itemDetails,{PORTAL_HOST:l}=e.config,u=(0,d.VG)(e.resourceName)?h.E2:e.resourceName,c=!e.resource&&!e.options?.params?.text&&!e.resourceProperties&&!e.options?.params?.properties;e.isRemove||u!==h.E2&&(e.isAdd||c)||(t=await (0,h.IQ)({resourceName:u,itemId:o,itemOwner:n,portalHost:l,authManager:a}),await P({authManager:a,config:e.config,itemDetails:e.itemDetails,isDataLossAllowed:e.isDataLossAllowed,resourceName:u,currentResourceProperties:t,itemResourcesEditInfo:e.itemResourcesEditInfo}));let m=r=>(i={editor:a.username,modified:Date.now(),id:(0,s.Ak)()},{...{authentication:a,id:o,name:e.resourceName,resource:e.resource,owner:n,private:!0!==e.isPublished},...e.options,...{params:{...e.options?.params,...r||!c?{properties:(0,h.Hv)({newProps:{...e.options?.params?.properties,...e.resourceProperties,editInfo:i},currentProps:t})}:{}}}});if(!0===e.isAdd){let t=await (0,r.zk)(m(!0));return await _({authManager:a,resourceName:u,editInfo:i,config:e.config,itemDetails:e.itemDetails,itemResourcesEditInfo:e.itemResourcesEditInfo}),t}if(!1===e.isAdd){let t=await (0,r.Fr)(m(!1));return await _({authManager:a,resourceName:u,editInfo:i,config:e.config,itemDetails:e.itemDetails,itemResourcesEditInfo:e.itemResourcesEditInfo}),t}if(!0===e.isRemove){let t=m(!1),s=await (0,r.at)({authentication:t.authentication,id:t.id,resource:t.name,owner:t.owner});return u!==h.E2&&await _({authManager:a,resourceName:u,editInfo:i,config:e.config,itemDetails:e.itemDetails,itemResourcesEditInfo:e.itemResourcesEditInfo,removeTrackingInfo:!0}),s}try{let t=await (0,r.Fr)(m(!1));if(t.success)return await _({authManager:a,resourceName:u,editInfo:i,config:e.config,itemDetails:e.itemDetails,itemResourcesEditInfo:e.itemResourcesEditInfo}),t;throw t}catch(s){let t=await (0,r.zk)(m(!0));return await _({authManager:a,resourceName:u,editInfo:i,config:e.config,itemDetails:e.itemDetails,itemResourcesEditInfo:e.itemResourcesEditInfo}),t}},_=async e=>{let{authManager:t,config:i,editInfo:a,itemDetails:s,removeTrackingInfo:r,resourceName:o,itemResourcesEditInfo:n}=e;if(r)return void delete n[o];let l=(0,d.VG)(o)?h.E2:o;if(a)n[l]=a;else{let e=await (0,h.IQ)({resourceName:l,itemId:s.id,authManager:t,portalHost:i.PORTAL_HOST,itemOwner:s.owner});n[l]=e?.editInfo}},P=async e=>{let{authManager:t,config:i,currentResourceProperties:a,isDataLossAllowed:s,itemDetails:r,itemResourcesEditInfo:o,resourceName:n}=e;if(!s&&(n=n?(0,d.VG)(n)?h.E2:n:h.E2,a=a||await (0,h.IQ)({resourceName:n,itemId:r.id,itemOwner:r.owner,portalHost:i.PORTAL_HOST,authManager:t}),!f.test(n)&&a?.editInfo?.id&&o?.[n]?.id&&o?.[n]?.id!==a?.editInfo?.id))throw new b(a,"Data resource will be overwritten")},E=async e=>{let{authManager:t,config:i,draftResourceId:a,mode:s,itemDetails:r,itemData:n,itemDraftData:l,isDataLossAllowed:h,isDuplicateCleanup:f,itemResourcesEditInfo:S,itemResourceIdsToKeep:b,type:I}=e,_=s!==g.uB.DISCARDING_UNPUBLISHED_CHANGES?l:void 0,P=s===g.uB.UNPUBLISHING?void 0:n,E=(0,A.sN)(_,P,I),T=await (0,o.EY)({authManager:t,username:r.owner,itemId:r.id,portal:(0,u.mZ)(i.PORTAL_HOST,t)}),O=await v({authManager:t,config:i,itemId:r.id,resources:E.publishedItemResources,version:g.CN.PUBLISHED,mode:s}),C=await v({authManager:t,config:i,itemId:r.id,resources:E.draftItemResources,version:g.CN.DRAFT,mode:s}),M=f?{maxRetries:60,delay:5e3}:g.uB.DRAFT_SAVE?{maxRetries:0}:{},N=T.map(e=>{let n=e.resource;if(n===a||s===g.uB.DRAFT_SAVE&&(["oembed.json","oembed.xml",c.J].includes(n)||b?.has((0,o.Pn)(n))||!(0,d.VG)(n)&&Date.now()-864e5<e.created));else if(O.indexOf(n)>=0){if("inherit"!==e.access)return(0,m.O$)(w,{...M,promiseArguments:[{authManager:t,config:i,isAdd:!1,isPublished:!0,itemDetails:r,itemResourcesEditInfo:S,resourceName:n}]})}else if(!(C.indexOf(n)>=0))return(0,m.O$)(w,{...M,promiseArguments:[{authManager:t,config:i,isRemove:!0,itemDetails:r,itemResourcesEditInfo:S,resourceName:n}]});else if("private"!==e.access)return(0,m.O$)(w,{...M,promiseArguments:[{authManager:t,config:i,isAdd:!1,isPublished:!1,itemDetails:r,itemResourcesEditInfo:S,resourceName:n}]})}),L=await Promise.all(N);if(s===g.uB.PUBLISHING){let e=E.itemResourcesToPublish.map(e=>{if((0,A.CE)(e.type))return R({authManager:t,config:i,itemDetails:r,filename:e.id,source:g.CN.DRAFT,destination:g.CN.PUBLISHED,isDataLossAllowed:h,itemResourcesEditInfo:S})}),a=await Promise.all([...e]);L=L.concat(a)}else if(s===g.uB.DISCARDING_UNPUBLISHED_CHANGES){let e=E.publishedItemResources.map(e=>{if((0,A.CE)(e.type))return R({authManager:t,config:i,itemDetails:r,filename:e.id,source:g.CN.PUBLISHED,destination:g.CN.DRAFT,isDataLossAllowed:h,itemResourcesEditInfo:S})}),a=await Promise.all([...e]);L=L.concat(a)}return I!==p.z.Theme&&await D({authManager:t,itemId:r.id,relationships:E.relatedItems,mode:s,isSMXItemInAGSM:(0,y.c)(r)||(0,y.H)(r)}),L},v=async e=>{let{resources:t,version:i,mode:a,itemId:s,authManager:r,config:n}=e,l=[],d=t.map(e=>"expressmap"===e.type?(i===g.CN.PUBLISHED&&a===g.uB.PUBLISHING?l.push(T({authManager:r,config:n,itemId:s,expressMapId:e.id,version:g.CN.DRAFT})):i===g.CN.DRAFT&&a===g.uB.DISCARDING_UNPUBLISHED_CHANGES?l.push(T({authManager:r,config:n,itemId:s,expressMapId:e.id,version:g.CN.PUBLISHED})):l.push(T({authManager:r,config:n,itemId:s,expressMapId:e.id,version:i})),(0,o.sD)(e.id,i)):(0,A.CE)(e.type)?(0,o.sD)(e.id,i):e.id,[]);return(await Promise.all(l)).reduce((e,t)=>e.concat(t),d)},T=async e=>{let{authManager:t,config:i,expressMapId:s,itemId:r,version:o}=e,n=O({authManager:t,config:i,itemId:r,filename:s,version:o}),l=await (0,a.Em)(n,{authentication:t,httpMethod:"GET"});return Object.keys(l.popups).reduce((e,t)=>{let i=l.popups[t];return i.image&&"string"==typeof i.image?e.concat(i.image):e},[])},R=async e=>{let{authManager:t,config:i,destination:s,filename:r,isDataLossAllowed:n,itemDetails:d,itemResourcesEditInfo:h,source:u}=e,c=O({authManager:t,config:i,itemId:d.id,filename:r,version:u}),m=await (0,a.Em)(c,{authentication:t});return w({authManager:t,config:i,itemDetails:d,isDataLossAllowed:n,isPublished:s===g.CN.PUBLISHED,resourceName:(0,o.sD)(r,s),resource:(0,l.YX)(m),itemResourcesEditInfo:h})},O=e=>{let{authManager:t,config:i,filename:a,itemId:s,version:r}=e;return`${(0,u.mZ)(i.PORTAL_HOST,t)}/content/items/${s}/resources/${(0,o.sD)(a,r)}`};var C=i(325247),M=i(812160),N=i(647345),L=i(254033);let k=Object.freeze({[p.z.Story]:L.A.Category.Story,[p.z.Collection]:L.A.Category.Collection,[p.z.Theme]:L.A.Category.Theme,[p.z.Briefing]:L.A.Category.Briefing,[p.z.Frame]:L.A.Category.Frame}),U={[p.z.Story]:L.A.Category.StoryTemplate},B=async e=>{let{authManager:t,config:i,fallbackThumbnailUrl:a,isDataLossAllowed:s,itemResourcesEditInfo:n,itemDetails:l,sharingLevel:d,type:h}=e,u=d.isUnlisted&&d.access===C.uQ.PUBLIC,c=await (0,o.L)({itemDetails:l,authManager:t}),m=await t.getUser(),y=[].concat(m.groups||[]).reduce((e,t)=>(e[t.id]=t,e),{}),f=m.favGroupId,g=(0,o.l$)(l,t),D=c.filter(e=>e!==f&&!d.groups?.includes(e)&&(0,M.I)({group:y[e],hasItemOwnerPermission:g,allowSharingToUpdateGroups:!0})),b=(d.groups??[]).filter(e=>e!==f&&!c?.includes(e)&&(0,M.I)({group:y[e],hasItemOwnerPermission:g,allowSharingToUpdateGroups:!0})),A=!1,w=l.typeKeywords?.includes(S.aE);u&&!w?(l.typeKeywords?.push(S.aE),A=!0):!u&&w&&(l.typeKeywords=l.typeKeywords?.filter(e=>e!==S.aE),A=!0);let _=(0,o.tD)(l),P=(0,N.WE)(l);!_&&(P||d.isViewerDuplicable)?(l.isViewerCopiable=!0,A=!0):!d.isViewerDuplicable&&_&&(l.isViewerCopiable=!1,A=!0);let E=l.typeKeywords?.includes(S.Sy);(d.isIndexable&&d.access===C.uQ.PUBLIC||d.access!==C.uQ.PUBLIC)&&E?(l.typeKeywords=l.typeKeywords?.filter(e=>e!==S.Sy),A=!0):d.access!==C.uQ.PUBLIC||d.isIndexable||E||(l.typeKeywords?.push(S.Sy),A=!0),A&&(await (0,r.fk)({authentication:t,item:l}),A=!1);let v=g?[(0,r.KP)({id:l.id,access:d.access===C.uQ.SHARED?C.uQ.PRIVATE:d.access,authentication:t,owner:l.owner})]:[],T=b.map(e=>(0,r.YG)({id:l.id,groupId:e,confirmItemControl:!0,authentication:t,owner:l.owner})),R=D.map(e=>(0,r.Bq)({id:l.id,groupId:e,authentication:t,owner:l.owner}));d.access===C.uQ.PUBLIC&&h!==p.z.Theme&&await I({authManager:t,config:i,fallbackThumbnailUrl:a,isDataLossAllowed:s,itemId:l.id,itemResourcesEditInfo:n});let O=P&&h===p.z.Story?U[h]:k[h];return L.A.trackEvent(O,L.A.Action.Story_ShareStory,d.isUnlisted?"unlisted":d.access),await Promise.all([...v,...T,...R])};var F=i(34863),$=i(602422);let G=e=>{let{mode:t,itemDetails:i,itemDraftData:a}=e;if(t!==g.uB.PUBLISHING&&t!==g.uB.UNPUBLISHING&&(0,N.$l)(i)!==F.hX.draft)return i;if("object"==typeof a.nodes){let e=(()=>{for(let e of Object.values(a.nodes))if("tour"===e.type&&e.data?.type==="guided-tour")return!0;return!1})(),t=(i.typeKeywords??[]).filter(e=>e!==S.CS);e&&t.push(S.CS),i.typeKeywords=t}return i},K=async e=>{let{appVersion:t,authManager:i,config:s,isDataLossAllowed:o,isDuplicateCleanup:n,itemData:d,itemDetails:h,itemDraftData:c,itemResourcesEditInfo:m,itemResourceIdsToKeep:p,mode:y,storeBackup:f,type:D}=e,b=`draft_${Date.now()}.json`,A=h.typeKeywords?.filter(e=>!e.match(g.by.draft)&&e!==S.DD)??[];A.push(`${g.by.draft}:${t}`),h.typeKeywords=A,G({mode:y,itemDetails:h,itemDraftData:c});try{f?.()}catch{}h.typeKeywords=(0,$.OM)({typeKeywords:h.typeKeywords,typeKeywordId:S.MZ}),h.typeKeywords=(0,$.d6)({typeKeywords:h.typeKeywords,typeKeywordId:S.Fc,data:b});let I=await w({authManager:i,itemDetails:h,config:s,isPublished:!1,isAdd:!0,isDataLossAllowed:o,itemResourcesEditInfo:m,resourceName:b,resource:(0,l.YX)(c)}),_=h.thumbnail instanceof Blob,P={...h};if(delete P.serviceProxyParams,await (0,a.Em)(`${(0,u.mZ)(s.PORTAL_HOST,i)}/content/users/${h.owner}/items/${h.id}/update
  `,{authentication:i,params:{...P,..._?{thumbnail:h.thumbnail}:{},text:y===g.uB.PUBLISHING||y===g.uB.UNPUBLISHING?d:void 0}}),_){let{thumbnail:e}=await (0,r.Gq)(h.id,{authentication:i});h.thumbnail=e}let v=await E({authManager:i,config:s,draftResourceId:b,isDataLossAllowed:o,isDuplicateCleanup:n,itemDetails:h,itemData:d,itemDraftData:c,itemResourcesEditInfo:m,itemResourceIdsToKeep:p,mode:y,type:D});return{draftData:I,itemDetails:h,updateResources:v,itemDraftData:c,itemData:d}},H=(e,t)=>[...t.filter(e=>e!==F.hX.draft&&e!==F.hX.published&&e!==F.hX.unpublishedChanges&&"status:draft"!==e&&"status:published"!==e&&"status:unpublished-changes"!==e),e],x=e=>{let{itemDetails:t,...i}=e;return(0,N.$l)(t)===F.hX.published&&(t.typeKeywords=H(F.hX.unpublishedChanges,t.typeKeywords??[])),K({...i,itemDetails:t,mode:g.uB.DRAFT_SAVE})};var z=i(504368),V=i(9653);let j=e=>{let{root:t,nodes:i}=e;if(!t||!i)return[];let a=i[t];return a.config?.allowedTranslations},W=async e=>{let{authManager:t,itemDetails:i,portalHost:s,itemDraftData:r,previousAllowedTranslations:o}=e,n=j(r),l=n&&n?.length>0,d=n?.filter(e=>{if(!o?.includes(e))return e}),h=o?.filter(e=>{if(!n?.includes(e))return e});if(d)try{let e=await (0,z.Lc)({filter:V.b.fetchAllPublicySharedPublishedStoriesByIds(d),authentication:t});await Promise.all(d.map(r=>{let o=`${g.cC.hasTranslation}:${i.id}`,n=e.results.find(e=>e.id===r),l=[...n?.typeKeywords??[],o];return(0,a.Em)(`${(0,u.mZ)(s,t)}/content/users/${i.owner}/items/${r}/update`,{authentication:t,params:{...n,typeKeywords:l}})}))}catch(e){console.error("Error linking translated items",e)}if(h)try{let e=await (0,z.Lc)({filter:V.b.fetchAllPublicySharedPublishedStoriesByIds(h),authentication:t});await Promise.all(h.map(r=>{let o=e.results.find(e=>e.id===r),n=o?.typeKeywords?.indexOf(`${g.cC.hasTranslation}:${i.id}`),l=o?.typeKeywords;return n&&l?.splice(n,1),(0,a.Em)(`${(0,u.mZ)(s,t)}/content/users/${i.owner}/items/${r}/update`,{authentication:t,params:{...o,typeKeywords:l}})}))}catch(e){console.error("Error unlinking translated items",e)}return!!l},J=(e,t)=>{let{root:i,nodes:a}=e;if(!i||!a)return;let s=a[i],r=s.config?.shouldUnlink,o=t.typeKeywords?.find(e=>e.includes(g.cC.hasTranslation)?e:void 0);return s.config?.shouldUnlink&&r&&delete s.config.shouldUnlink,r?o:void 0},X=async e=>{let{appVersion:t,authManager:i,config:a,fallbackThumbnailUrl:s,isDataLossAllowed:r,isDuplicateCleanup:o,itemDetails:n,itemDraftData:d,itemResourcesEditInfo:h,sharingLevel:u,storeBackup:m,type:p,previousAllowedTranslations:y}=e,f=await W({authManager:i,itemDetails:n,portalHost:a.PORTAL_HOST,itemDraftData:d,previousAllowedTranslations:y}),S=J(d,n);n.typeKeywords=Y(n,t,{hasTranslations:f,translationShouldUnlinkFromSource:S});let D=await K({appVersion:t,authManager:i,config:a,isDataLossAllowed:r,isDuplicateCleanup:o,itemDetails:n,itemData:d,itemDraftData:d,itemResourcesEditInfo:h,mode:g.uB.PUBLISHING,storeBackup:m,type:p}),b=await B({authManager:i,config:a,fallbackThumbnailUrl:s,itemDetails:n,isDataLossAllowed:r,itemResourcesEditInfo:h,sharingLevel:u,type:p}),A=await w({authManager:i,config:a,isAdd:!0,isDataLossAllowed:r,isPublished:!0,itemDetails:n,itemResourcesEditInfo:h,resourceName:c.J,resource:(0,l.YX)(d)});return{...D,serverItemData:A,shareItem:b}},Y=(e,t,i)=>{let a=(0,$.Y)({typeKeywords:e.typeKeywords,typeKeywordId:g.cC.firstPublishedDate}),s=(0,$.Y)({typeKeywords:e.typeKeywords,typeKeywordId:g.cC.publishedDate}),r=(0,$.Y)({typeKeywords:e.typeKeywords,typeKeywordId:g.cC.hasTranslation}),o=Date.now(),n=e.typeKeywords?.filter(e=>!e.match(g.cC.publishedDate)&&!e.match(g.by.published)&&!e.match(S.lt))??[];if(n.push(`${g.cC.publishedDate}:${o}`),n.push(`${g.by.published}:${t}`),a||s||n.push(`${g.cC.firstPublishedDate}:${o}`),i.hasTranslations&&!r)n.push(g.cC.hasTranslation);else if(!i.hasTranslations&&r){let e=n.indexOf(g.cC.hasTranslation);n.splice(e,1)}if(i.translationShouldUnlinkFromSource){let e=n.indexOf(i.translationShouldUnlinkFromSource);n.splice(e,1)}return H(F.hX.published,n)},q=e=>{let{itemDetails:t,...i}=e;return t.typeKeywords=H(F.hX.published,t.typeKeywords??[]),K({...i,itemDetails:t,itemDraftData:i.itemData,mode:g.uB.DISCARDING_UNPUBLISHED_CHANGES})},Z=async e=>{let{authManager:t,config:i,fallbackThumbnailUrl:a,isDataLossAllowed:s,itemDetails:r,itemResourcesEditInfo:o,sharingLevel:n,type:l}=e;r.typeKeywords=Q(r);let d=await K({...e,itemData:{unpublished:!0},mode:g.uB.UNPUBLISHING}),h=await B({authManager:t,config:i,itemDetails:r,isDataLossAllowed:s,fallbackThumbnailUrl:a,sharingLevel:n,itemResourcesEditInfo:o,type:l});return{...d,shareItem:h}},Q=e=>{let t=e.typeKeywords?.filter(e=>!e.match(g.cC.publishedDate)&&!e.match(g.cC.firstPublishedDate)&&!e.match(g.by.published)&&!e.match("Copy Item")&&!e.match(S.hd))??[];return H(F.hX.draft,t)};var ee=i(387189),et=i(104471),ei=i(299712),ea=i(777142),es=i(918300),er=i(226453),eo=i(270350),en=i(213218),el=i(531024),ed=i(789016),eh=i(958280),eu=i(819915);let ec=e=>{let t={giphy:0,unsplash:0,coverr:0};for(let i in e){let a=e[i].data.provider;("giphy"===a||"unsplash"===a||"coverr"===a)&&t[a]++}return t},em=(e,t,i)=>{let a=ec(e);L.A.trackEvent(t,i,L.A.Name.UnsplashImage_PublishedStory_Count,a.unsplash),L.A.trackEvent(t,i,L.A.Name.GiphyImage_PublishedStory_Count,a.giphy),L.A.trackEvent(t,i,L.A.Name.CoverrVideo_PublishedStory_Count,a.coverr)},ep=Object.freeze({resource:"customTheme",order:"themeBasemap",media:"mediaBasemap",locale:"chineseBasemap",name:"basemapPicker",json:"jsonBasemap"}),ey=async(e,t,i,s,o)=>{let n=Object.keys(t);await Promise.all(n.map(async n=>{if("expressmap"===t[n].type){let r=O({authManager:s,config:o,filename:t[n]?.data.itemId,itemId:i,version:"draft"}),l=await (0,a.Em)(r,{authentication:s,httpMethod:"GET"}),d=ep[l.basemap.type]||"unknownBasemap";L.A.trackEvent(e,L.A.Action.ExpressMap_PublishedExpressmapBaseMapType,d,0,"name"===l.basemap.type?t[n]?.data.value:void 0)}if("json"===t[n].type){let a=t[n].data.resourceId;if(a.startsWith("chart")){let t=await (0,r.ov)(i,{fileName:a,readAs:"json",authentication:s}),o=t.type,n=t.dataType;L.A.trackEvent(e,L.A.Action.Chart_PublishedChartType,o),L.A.trackEvent(e,L.A.Action.Chart_PublishedChartDataType,n,0)}}}))},ef=e=>"string"==typeof e?e:"object"==typeof e?e.cols+"x"+e.rows:"unknown",eg=(e,t,i)=>{t.data?.categories&&t.data.categories.forEach(a=>{L.A.trackEvent(e,t.type+L.A.Action.StoryStatistics_CustomIconType,a.icon||"default",0,i.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish)})},eS=async e=>{try{let t=e.isTemplate?L.A.Category.StoryTemplate:({[p.z.Story]:L.A.Category.Story,[p.z.Frame]:L.A.Category.Frame,[p.z.Briefing]:L.A.Category.Briefing,[p.z.Collection]:L.A.Category.Collection,[p.z.Theme]:L.A.Category.Theme})[e.type],i=e.isTemplate?L.A.Category.StoryTemplateStatistics:({[p.z.Story]:L.A.Category.StoryStatistics,[p.z.Frame]:L.A.Category.FrameStatistics,[p.z.Briefing]:L.A.Category.BriefingStatistics,[p.z.Collection]:L.A.Category.CollectionStatistics,[p.z.Theme]:L.A.Category.ThemeStatistics})[e.type],a=e.isTemplate?L.A.Action.StoryTemplate_PublishTemplate:({[p.z.Story]:L.A.Action.Story_PublishStory,[p.z.Frame]:L.A.Action.Frame_PublishFrame,[p.z.Briefing]:L.A.Action.Briefing_PublishBriefing,[p.z.Collection]:L.A.Action.Collection_PublishCollection,[p.z.Theme]:L.A.Action.Theme_PublishTheme})[e.type];if((0,$.cW)({typeKeywords:e.itemDetails.typeKeywords??[],typeKeywordId:S.hd}).forEach(t=>{L.A.trackEvent(L.A.Category.Story,e.firstPublish?L.A.Action.StoryStatistics_FirstPublish_Topic:L.A.Action.StoryStatistics_Republish_Topic,t)}),L.A.trackEvent(t,a,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish),Object.keys(e.itemData.resources).forEach(i=>{let a=e.itemData.resources[i];if("story-theme"===a.type){let i=a.data.themeItemId??a.data.themeId;L.A.trackEvent(t,L.A.Action.GeneralStatistics_PublishedTheme,i,0,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish)}}),em(e.itemData.resources,t,a),await ey(i,e.itemData.resources,e.itemDetails.id,e.authManager,e.config),e.firstPublish){let i,{licenseType:a}=e;a||(a=""),i="SMX Item"===e.itemDetails.type||"SMX Theme"===e.itemDetails.type?"SMX":a.includes("creator")?L.A.Name.Story_PublishStory_UserType_Creator:a.includes("GISProfessional")?L.A.Name.Story_PublishStory_UserType_GISProfessional:a.includes("Storyteller")?L.A.Name.Story_PublishStory_UserType_StoryTeller:L.A.Name.Story_PublishStory_UserType_Public,L.A.trackEvent(t,L.A.Action.Story_PublishStory_UserType,i)}let s=new Date,r=(t,i)=>{if(!t.dependents?.offline)return;let a="string"==typeof t.dependents.offline?t.dependents.offline:t.dependents.offline[0],s=e.itemData.nodes[a].type;i[t.type]?i[t.type][s]=i[t.type][s]+1||1:i[t.type]={[s]:1}};if(e.firstPublish?L.A.trackEvent(i,L.A.Action.StoryStatistics_FirstPublish_DayOfMonth,s.getDate().toString()):L.A.trackEvent(i,L.A.Action.StoryStatistics_Republish_DayOfMonth,s.getDate().toString()),L.A.trackEvent(i,(0,o.tD)(e.itemDetails)?L.A.Action.ItemStatistics_AllowPublishedDuplicate:L.A.Action.ItemStatistics_DoNotAllowPublishedDuplicate,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish),L.A.trackEvent(i,(0,o.e5)({itemDetails:e.itemDetails,isTemplate:e.isTemplate})?L.A.Action.ItemStatistics_OptIntoSEO:L.A.Action.ItemStatistics_OptOutOfSEO,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish),"story"===e.type){let t={},a=0,s=0,r=0,o=0;Object.keys(e.itemData.nodes).forEach(n=>{let l=e.itemData.nodes[n];if("immersive-slide"!==l.type&&"immersive-side-panel"!==l.type){if("immersive"===l.type){let e=l.data.type;"sidecar"===e&&(e="floating-panel"===l.data.subtype?"sidecar-float":"docked-panel"===l.data.subtype?"sidecar-docked":"sidecare-slideshow"),l.type=e}else"gallery"===l.type&&(l.type="square-dynamic"===l.data.galleryLayout?"gallery-square-dynamic":"jigsaw"===l.data.galleryLayout?"gallery-jigsaw":"gallery-filmstrip");if("number"==typeof t[l.type]?t[l.type]=t[l.type]+1:t[l.type]=1,("image"===l.type||"video"===l.type||"audio"===l.type||"embed"===l.type||"expressmap"===l.type||"thematic-map"===l.type||"webmap"===l.type||"swipe"===l.type)&&(s+=1,l.data?.alt?.length>0&&(r+=1)),"video"===l.type&&(l.data?.closedCaption&&(a+=1),l.data?.transcript&&(o+=1)),"large-number"===l.type&&(L.A.trackEvent(i,L.A.Action.StoryStatistics_LargeNumberIconPosition,l.data?.iconPosition||"default",0,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish),L.A.trackEvent(i,l.type+L.A.Action.StoryStatistics_CustomIconType,l.data?.icon||"default",0,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish)),l.data&&("slideshow"===l.type||"sidecar-float"===l.type||"sidecar-docked"===l.type)&&(l.data.type,L.A.trackEvent(i,e.firstPublish?L.A.Action.StoryStatistics_SideCar_FirstPublish_SlidesCount:L.A.Action.StoryStatistics_SideCar_Republish_SlidesCount,L.A.Name.Builder_Sidecar,l.children?l.children.length:0)),"table"===l.type&&l.data){let{numRows:t,numColumns:a}=l.data;L.A.trackEvent(i,e.firstPublish?L.A.Action.StoryStatistics_Table_FirstPublish_NumRows:L.A.Action.StoryStatistics_Table_Republish_NumRows,L.A.Name.Builder_Table,t),L.A.trackEvent(i,e.firstPublish?L.A.Action.StoryStatistics_Table_FirstPublish_NumColumns:L.A.Action.StoryStatistics_Table_Republish_NumColumns,L.A.Name.Builder_Table,a)}if("grid"===l.type&&l.children&&l.children.length>0){let t=l.children.length,a=e.itemData.nodes[l.children[0]].type;L.A.trackEvent(i,L.A.Action.StoryStatistics_GridChildBlockType_Count,a,t,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish)}if("tour"===l.type&&l.data){let t="explorer"===l.data.type;L.A.trackEvent(i,e.firstPublish?t?L.A.Action.StoryStatistics_Explorer_FirstPublish_SlidesCount:L.A.Action.StoryStatistics_GuidedTour_FirstPublish_SlidesCount:t?L.A.Action.StoryStatistics_Explorer_Republish_SlidesCount:L.A.Action.StoryStatistics_GuidedTour_Republish_SlidesCount,t?L.A.Name.Builder_Explorer:L.A.Name.Builder_GuidedTour,l.data.places?l.data.places.length:0);let a="",s=!1;switch(l.data.subtype){case"map-focused":a="Map_Focused";break;case"media-focused":a="Media_Focused";break;case"list":a="List";break;case"grid":a="Grid";break;case"categorized":a="Categorized_List",s=!0;break;case"categorized-grid":a="Categorized_Grid",s=!0}s&&eg(i,l,e),L.A.trackEvent(i,t?L.A.Action.StoryStatistics_Explorer_Layout:L.A.Action.StoryStatistics_GuidedTour_Layout,a)}if("credits"===l.type&&l.config&&!l.config.isHidden&&L.A.trackEvent(i,e.firstPublish?L.A.Action.StoryStatistics_FirstPublish_CreditsToggledOn:L.A.Action.StoryStatistics_Republish_CreditsToggledOn),"story"===l.type){if(l.config?.storyLocale&&L.A.trackEvent(i,e.firstPublish?L.A.Action.StoryStatistics_FirstPublish_StoryLocale:L.A.Action.StoryStatistics_Republish_StoryLocale,l.config.storyLocale),l.config?.analytics){let t=l.config.analytics.type;L.A.trackEvent(i,e.firstPublish?L.A.Action.StoryStatistics_FirstPublish_AuthorAnalytics:L.A.Action.StoryStatistics_Republish_AuthorAnalytics,t)}l.config?.isSocialIconsHidden&&L.A.trackEvent(i,e.firstPublish?L.A.Action.StoryStatistics_FirstPublish_HideSocialShare:L.A.Action.StoryStatistics_Republish_HideSocialShare),L.A.trackEvent(i,e.firstPublish?L.A.Action.StoryStatistics_FirstPublish_CoverDate:L.A.Action.StoryStatistics_Republish_CoverDate,l.config?.coverDate),a>0&&L.A.trackEvent(i,L.A.Action.GeneralStatistics_PublishedWithVideoClosedCaption,a.toString(),0,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish),o>0&&L.A.trackEvent(i,L.A.Action.GeneralStatistics_PublishedWithVideoTranscript,o.toString(),0,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish)}}});let n=e.firstPublish?L.A.Action.StoryStatistics_FirstPublish_NodeCount:L.A.Action.StoryStatistics_Republish_NodeCount;Object.keys(t).forEach(e=>{L.A.trackEvent(i,n,e,t[e])});let l=e.firstPublish?L.A.Action.StoryStatistics_FirstPublish_AltTextUsed:L.A.Action.StoryStatistics_Republish_AltTextUsed,d=s>0&&r>0,h=Math.round(r/s*100);L.A.trackEvent(i,l,d.toString(),h)}if(e.type===p.z.Theme){let{resources:t,titleFont:a,bodyFont:s,variables:r}=e.itemData,o={title:{action:e.firstPublish?L.A.Action.ThemeStatistics_FirstPublish_TitleFont:L.A.Action.ThemeStatistics_Republish_TitleFont,themeVariablesFontId:r.titleFontId},body:{action:e.firstPublish?L.A.Action.ThemeStatistics_FirstPublish_BodyFont:L.A.Action.ThemeStatistics_Republish_BodyFont,themeVariablesFontId:r.bodyFontId}};(a=>{let s={google:0};a.forEach(e=>{let{type:a,data:r}=e,n=o[a];if((0,eu.dE)(n.themeVariablesFontId))return void L.A.trackEvent(i,n.action,eh.n9[n.themeVariablesFontId].displayName);if(!r)return;let l=t?.[r.resource]?.data;l&&(s[l.provider]=(s[l.provider]||0)+1,L.A.trackEvent(i,n.action,l.displayName))}),s.google&&L.A.trackEvent(i,e.firstPublish?L.A.Action.ThemeStatistics_FirstPublish_UsedGoogleFonts:L.A.Action.ThemeStatistics_Republish_UsedGoogleFonts)})([{type:"title",data:a},{type:"body",data:s}])}if(e.type===p.z.Collection){let t=!1;Object.keys(e.itemData.nodes).forEach(a=>{let s=e.itemData.nodes[a];if("collection-cover"===s.type){t=("object"==typeof s.data&&"mapOptions"in s.data?s.data.mapOptions:{}).isEnabled;let a=s.children?s.children?.reduce((t,i)=>{let a=e.itemData.nodes[i];if("text"===a.type){let e=a.data.text,i=(0,ed.wr)(e??"");return{nodeCount:t.nodeCount+1,characterCount:t.characterCount+i.length}}return t},{nodeCount:0,characterCount:0}):{nodeCount:0,characterCount:0};L.A.trackEvent(i,L.A.Action.Collection_Description_TextBlocks,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish,a?.nodeCount),L.A.trackEvent(i,L.A.Action.Collection_Description_CharacterCount,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish,a?.characterCount)}if("collection-map"===s.type){let t="object"==typeof s.data&&"geometries"in s.data?Object.keys(s.data.geometries).length:0;L.A.trackEvent(i,L.A.Action.Collection_LocationCount,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish,t)}}),L.A.trackEvent(i,L.A.Action.CollectionPublishedWithMap,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish,0,t?"true":"false")}if("briefing"===e.type){let t={},a={},s={},o={},n={},l={},d=0;Object.keys(e.itemData.nodes).forEach(s=>{let h=e.itemData.nodes[s];if(t[h.type]=t[h.type]+1||1,"briefing-slide"===h.type){let t=h.data.sublayout?h.data.layout+":"+ef(h.data.sublayout):h.data.layout;if(a[t]=a[t]+1||1,h.data.title){let t=e.itemData.nodes[h.data.title],a=t?.data?.text.length;L.A.trackEvent(i,L.A.Action.BriefingStatistics_PublishedSlideTitleLength,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish,a)}}if("storycover"===h.type&&h.children){let t=h.children[0],a=e.itemData.nodes[t].type;L.A.trackEvent(i,L.A.Action.BriefingStatistics_CoverMediaType,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish,0,a)}if("image"===h.type||"video"===h.type){let e=h.type,t=h.config&&h.config?.placement?h.config.placement.type:"fill";"image"===e&&(o[t]=o[t]+1||1),"video"===e&&(n[t]=n[t]+1||1,"object"==typeof h.data&&"closedCaption"in h.data&&(d+=1))}("webmap"===h.type||"expressmap"===h.type||"embed"===h.type)&&r(h,l)}),Object.keys(t).forEach(a=>{L.A.trackEvent(i,e.firstPublish?L.A.Action.StoryStatistics_FirstPublish_NodeCount:L.A.Action.StoryStatistics_Republish_NodeCount,a,t[a])}),Object.keys(a).forEach(t=>{L.A.trackEvent(i,L.A.Action.BriefingStatistics_PublishedSlideLayoutCount,t,a[t],e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish)}),Object.keys(l).forEach(t=>{Object.keys(l[t]).forEach(a=>{L.A.trackEvent(i,L.A.Action.StoryStatistics_OfflineMediaUsedBy+t,L.A.Name.OfflineMedia_Type+a,l[t][a],e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish)})}),Object.keys(s).forEach(t=>{L.A.trackEvent(i,L.A.Action.BriefingStatistics_PublishedTextTypeCount,t,s[t],e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish)}),Object.keys(o).forEach(t=>{L.A.trackEvent(i,L.A.Action.BriefingStatistics_PublishedImagePlacementCount,t,o[t],e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish)}),Object.keys(n).forEach(t=>{L.A.trackEvent(i,L.A.Action.BriefingStatistics_PublishedVideoPlacementCount,t,n[t],e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish)}),d>0&&L.A.trackEvent(i,L.A.Action.GeneralStatistics_PublishedWithVideoClosedCaption,e.firstPublish?L.A.Name.Story_PublishStory_FromDraft:L.A.Name.Story_PublishStory_Republish,d)}}catch{return}};async function eD(e){try{if(!(0,eo.f7)(e.itemData))return;return eS({...e,...window.structuredClone({itemData:e.itemData,itemDetails:e.itemDetails})})}catch{}}var eb=i(20421);function eA(e){return"story"===e.type||"collection"===e.type||"briefing"===e.type}function eI(e){return["storycover","collection-cover"].includes(e.type)}var ew=i(619266);let e_=async e=>{let{type:t,itemDetails:i,itemProperties:a,thumbnail:s,baseUrl:r,authManager:o,portalHost:l,shouldPushMetaToAGOItemDetails:d,shouldForceUpdateThumbnail:h}=e;if(t===p.z.Story||t===p.z.Collection||t===p.z.Briefing){let e=(0,ee.T)(i),t=JSON.stringify(e?.thumbnail??null),u=JSON.stringify(a?.thumbnail??null),c=a?.thumbnail?.[0]==="generated",m=!!(c&&s instanceof Blob)||t!==u&&"null"!==t;if("null"===u&&(a={...a,thumbnail:["default"]}),!m&&!h&&(i.thumbnailUrl||i.thumbnail instanceof Blob)&&(delete i.thumbnailUrl,delete i.thumbnail),m||h){if(s instanceof Blob&&(i.thumbnail=s),!d)return;if(!c){let e=i.thumbnailUrl?await (0,n.$n)((0,ew.Y2)(i.thumbnailUrl,{width:3e3,authManager:o,shouldIgnoreDPR:!0,portalHost:l}),{aspectRatio:1.5,zoom:5,quality:.8,type:"image/jpeg"}):await (0,eb.q_)(r);i.thumbnail=e}delete i.thumbnailUrl}}else void 0===s&&i.thumbnail instanceof Blob?delete i.thumbnail:s&&(i.thumbnail=s)};var eP=i(363681),eE=i(623329),ev=i(385526),eT=i(331366);let eR=e=>`smdraftrecovery_${e}`,eO=e=>{let t=eR(e);return JSON.parse(window.localStorage.getItem(t))},eC=(e,t)=>{try{{let i=eR(e),a=eO(e);if(a&&(!t||!a.downloaded))return(0,l.mS)(a.data,`StoryMap_Draft_Recovery_${e}`),window.localStorage.setItem(i,JSON.stringify({...a,downloaded:!0})),!0}}catch{}return!1},eM=Object.freeze({[p.z.Story]:L.A.Action.Story_UnpublishStory,[p.z.Collection]:L.A.Action.Collection_UnpublishCollection,[p.z.Theme]:L.A.Action.Theme_UnpublishTheme,[p.z.Briefing]:L.A.Action.Briefing_UnpublishBriefing,[p.z.Frame]:L.A.Action.Frame_UnpublishFrame}),eN=Object.freeze({[p.z.Story]:L.A.Action.Story_DuplicateStory,[p.z.Collection]:L.A.Action.Collection_DuplicateCollection,[p.z.Theme]:L.A.Action.Theme_DuplicateTheme,[p.z.Briefing]:L.A.Action.Briefing_DuplicateBriefing,[p.z.Frame]:L.A.Action.Frame_DuplicateFrame});var eL=function(e){return e[e.DRAFT_SAVE=0]="DRAFT_SAVE",e[e.PUBLISHING=1]="PUBLISHING",e[e.UNPUBLISHING=2]="UNPUBLISHING",e[e.DISCARDING_UNPUBLISHED_CHANGES=3]="DISCARDING_UNPUBLISHED_CHANGES",e}({});class ek extends eT.${static #e=this.fetchItemDraftData=async e=>{try{let t=await (0,d.hB)({itemDetails:e.itemDetails,portalHost:e.portalHost,authManager:e.authManager});if(t=await (0,ev.eq)(e,t),ek.validateItemData(e.type,t))return{itemData:t,itemDataVersion:"draft"};throw{itemData:t,itemDataVersion:"draft"}}catch(t){if((0,o.m5)(e.itemDetails))return{itemData:await ek.fetchPublishedItemData({type:e.type,itemId:e.itemDetails.id,authManager:e.authManager,portalHost:e.portalHost}),itemDataVersion:"published"};if(404===t.code){let t=eO(e.itemDetails.id),i=new eE.w(e.itemDetails.id,t&&t.data?t&&t.data:void 0);throw L.A.trackEvent(L.A.Category.Error,L.A.Action.Error_DraftDataMissing,e.trackRecoveryMode?L.A.Name.Draft_Recovery:void 0),i}throw t}};setPendingChanges(e,t,i){this.pendingChanges.set(t,{type:e,status:i})}getPendingChangesFor(e){return this.pendingChanges.get(e)}hasPendingChanges(e){let t=Array.from(this.pendingChanges.values());e&&(t=t.filter(t=>{let{type:i}=t;return e===i}));let i=Array.from(t.values()).map(e=>{let{status:t}=e;return t}).includes(!0);return i||e||this.pendingChanges.clear(),i}constructor(e){var t;super(e),t=this,this.itemDraftDataJSON="",this.isPublishWorkflowLocked=!1,this.itemResourcesEditInfo={},this.trackThirdPartyAppEditorApp=()=>{let e=(0,$.cW)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:S.MZ})[0];e&&L.A.trackEvent(L.A.Category.ThirdParty,this.type+L.A.Action.ThirdParty_Edited,e)},this.trackThirdPartyPubliserApp=()=>{let e=(0,$.cW)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:S.lt})[0];e&&L.A.trackEvent(L.A.Category.ThirdParty,this.type+L.A.Action.ThirdParty_Published,e)},this.isDataLossAllowed=!1,this.isDataRecoveryPendingReview=!1,this.pendingChanges=new Map,this.pendingChangesKey=Symbol(),this.isDraftDataFetchedFromPublishedData=!1,this.getItemPublishDate=()=>this.getItemPublishStatus()===F.hX.published&&super.getItemPublishDate(),this.setItemResourceIdsToKeep=e=>{this.itemResourceIdsToKeep=new Set(e)},this.upsertItemResource=e=>{let t=async()=>{try{return await w({...e,authManager:this.authManager,config:this.config,itemDetails:this.itemDetails,isDataLossAllowed:this.isDataLossAllowed,itemResourcesEditInfo:this.itemResourcesEditInfo})}catch(e){if(e instanceof b){if(await this.handleDataLossWarning(e.resourceProperties),this.isDataLossAllowed)return t();return{success:!1}}throw Error()}};return t()},this.confirmDataLossBeforeSave=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{await P({authManager:t.authManager,config:t.config,currentResourceProperties:e.currentResourceProperties,isDataLossAllowed:t.isDataLossAllowed,itemDetails:t.itemDetails,itemResourcesEditInfo:t.itemResourcesEditInfo,resourceName:e.resourceName})}catch(e){if(e instanceof b)await t.handleDataLossWarning(e.resourceProperties);else throw e}},this.addPendingItemRequest=e=>{let t=(0,m.YZ)(this.pendingItemRequests).then(e);return this.pendingItemRequests=t,t},this.shareStory=e=>{let t=async()=>{let t=this.isTemplate&&(0,N._E)(this.type)?U[this.type]:k[this.type];L.A.trackEvent(t,L.A.Action.Story_ShareStory,e?.access??this.itemSharingLevel.access);let i=await B({authManager:this.authManager,config:this.config,fallbackThumbnailUrl:`${location.origin}${(0,eb.b9)(this.config.BASE_URL)}`,isDataLossAllowed:this.isDataLossAllowed,itemDetails:this.itemDetails,itemResourcesEditInfo:this.itemResourcesEditInfo,sharingLevel:e??this.itemSharingLevel,type:this.type});return this.emit("share-end",i),i};return this.addPendingItemRequest(t)},this.saveDraft=()=>{let e=async()=>{if(!this.isDataRecoveryPendingReview)try{this.emit("story-save-start"),this.setPendingChanges("save",this.pendingChangesKey,!0),this.trackThirdPartyAppEditorApp(),await this.updateDataAndDetails(0);let{draftData:e,itemDetails:t,updateResources:i}=await x({appVersion:this.config.APP_VERSION,authManager:this.authManager,config:this.config,itemData:this.itemData,itemDetails:this.itemDetails,itemDraftData:this.itemDraftData,isDataLossAllowed:this.isDataLossAllowed,itemResourcesEditInfo:this.itemResourcesEditInfo,itemResourceIdsToKeep:this.itemResourceIdsToKeep,storeBackup:this.storeBackup,type:this.type});this.setItemDetails(t),this.onSaveEnd(void 0,[e,t,i])}catch(e){e instanceof b&&(await this.handleDataLossWarning(e.resourceProperties),this.isDataLossAllowed&&this.saveDraft())}};return this.addPendingItemRequest(e)},this.setTopicTags=e=>{if(!e?.length)return void this.removeTopicTags();let t=(0,$.d6)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:S.hd,data:e});this.setItemDetails({...this.itemDetails,typeKeywords:t})},this.removeTopicTags=()=>{this.setItemDetails({...this.itemDetails,typeKeywords:(0,$.OM)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:S.hd})})},this.publishStory=()=>{let e=async()=>{if(this.onPublishMethodStart(1))try{let e=this.itemDetails.properties?.allowedTranslations;await this.emitBeforePublish(e=>this.emit("publishStatusUpdate",e)),this.emit("story-save-start"),this.setPendingChanges("publish",this.pendingChangesKey,!0);let t=this.getItemPublishStatus()===F.hX.draft;await this.updateDataAndDetails(1);let{draftData:i,itemDetails:a,updateResources:s,serverItemData:r,shareItem:o,itemDraftData:n}=await X({appVersion:this.config.APP_VERSION,authManager:this.authManager,config:this.config,fallbackThumbnailUrl:`${location.origin}${(0,eb.b9)(this.config.BASE_URL)}`,itemDetails:this.itemDetails,itemDraftData:this.itemDraftData,isDataLossAllowed:this.isDataLossAllowed,itemResourcesEditInfo:this.itemResourcesEditInfo,sharingLevel:this.itemSharingLevel,storeBackup:this.storeBackup,type:this.type,previousAllowedTranslations:e});this.trackThirdPartyPubliserApp(),this.setItemDetails(a),this.setItemData(n),this.onSaveEnd(void 0,[i,a,s]);let l=[[i,a,s],o,r],d=(await this.authManager?.getUser()).userLicenseTypeId;await eD({type:this.type,itemDetails:this.itemDetails,isTemplate:this.isTemplate,itemData:this.itemData,firstPublish:t,licenseType:d,authManager:this.authManager,config:this.config}),this.onPublishMethodEnd(1,[t,null,l])}catch(e){if(e instanceof b)await this.handleDataLossWarning(e.resourceProperties),this.isDataLossAllowed&&this.publishStory();else throw this.onPublishMethodEnd(1,[!1,e]),Error(e)}};return this.addPendingItemRequest(e)},this.discardUnpublishedChanges=e=>{let t=async()=>{if(this.onPublishMethodStart(3))try{this.emit("story-save-start"),this.setPendingChanges("publish",this.pendingChangesKey,!0);let{draftData:t,itemDetails:i,updateResources:a}=await q({appVersion:this.config.APP_VERSION,authManager:this.authManager,config:this.config,itemData:this.itemData,itemDetails:this.itemDetails,isDataLossAllowed:this.isDataLossAllowed,isDuplicateCleanup:e,itemResourcesEditInfo:this.itemResourcesEditInfo,storeBackup:this.storeBackup,type:this.type});this.setItemDraftData(this.itemData),this.setItemDetails(i);let s=[t,i,a];this.onSaveEnd(void 0,[s]),e||L.A.trackEvent(k[this.type],L.A.Action.Story_DiscardUnpublishedChanges),this.onPublishMethodEnd(3,[s])}catch(e){if(e instanceof b)await this.handleDataLossWarning(e.resourceProperties),this.isDataLossAllowed&&await this.discardUnpublishedChanges();else throw this.onPublishMethodEnd(3,[null,e]),Error(e)}};return this.addPendingItemRequest(t)},this.unpublishStory=e=>{let t=async()=>{if(this.onPublishMethodStart(2))try{this.emit("story-save-start"),this.setPendingChanges("publish",this.pendingChangesKey,!0),await this.updateDataAndDetails(2,e);let{draftData:t,itemDetails:i,updateResources:a,shareItem:s,itemData:r}=await Z({appVersion:this.config.APP_VERSION,authManager:this.authManager,config:this.config,fallbackThumbnailUrl:`${location.origin}${(0,eb.b9)(this.config.BASE_URL)}`,itemDetails:this.itemDetails,itemDraftData:this.itemDraftData,isDataLossAllowed:this.isDataLossAllowed,isDuplicateCleanup:e,itemResourcesEditInfo:this.itemResourcesEditInfo,storeBackup:this.storeBackup,type:this.type,sharingLevel:er.s});this.setItemData(r),this.setItemDetails(i),this.itemSharingLevel=er.s,this.onSaveEnd(void 0,[t,i,a]);let o=[[t,i,a],s];e||L.A.trackEvent(this.isTemplate&&(0,N._E)(this.type)?U[this.type]:k[this.type],this.isTemplate?L.A.Action.Builder_Template:eM[this.type]),this.onPublishMethodEnd(2,[o])}catch(e){if(e instanceof b)await this.handleDataLossWarning(e.resourceProperties),this.isDataLossAllowed&&this.unpublishStory();else throw this.onPublishMethodEnd(2,[null,e]),Error(e)}};return this.addPendingItemRequest(t)},this.hasUnsavedChanges=async()=>this.itemDraftDataJSON!==JSON.stringify((await this.getStoryData(0)).itemData),this.setGetStoryDataMethod=e=>{this.getStoryData=e},this.setGenerateStoryItemUrlMethod=e=>{this.generateStoryItemUrl=e},this.setEmitBeforePublish=e=>{this.emitBeforePublish=e},this.setConfirmDataLossMethod=e=>{this.confirmDataLoss=e},this.setConfirmAdminAction=e=>{this.confirmAdminAction=e},this.fetchStoryBuilderData=async()=>{try{let e={itemId:this.itemId,authManager:this.authManager,portalHost:this.config.PORTAL_HOST},t={...e,type:this.type},i=await ek.fetchItemDetails(e);if("update"!==i.itemControl&&"admin"!==i.itemControl&&!i.origin)throw new en.D({type:"story-privileges-edit",itemType:this.type});if(this.setItemDetails(i),i.origin)throw new en.D({type:"distributed-collab-no-draft"});let a=(0,el.k8)(this.config.ITEM_SHARING_OPTIONS,this.itemDetails.typeKeywords),s=await (0,o.L)({itemDetails:this.itemDetails,authManager:this.authManager,excludeFavoritesGroup:!0});this.itemSharingLevel={access:this.itemDetails.access,groups:s,isUnlisted:a};try{let{itemData:e,itemDataVersion:t}=await ek.fetchItemDraftData({itemDetails:this.itemDetails,type:this.type,authManager:this.authManager,portalHost:this.config.PORTAL_HOST,trackRecoveryMode:!0});this.setItemDraftData(e),"published"===t&&(this.isDraftDataFetchedFromPublishedData=!0,this.setItemData(e))}catch(e){if((0,eE.p)(e))this.isDataRecoveryPendingReview=!0,this.setItemDraftData(e.recoveryDraftData);else throw e}if(await _({authManager:this.authManager,config:this.config,itemDetails:this.itemDetails,itemResourcesEditInfo:this.itemResourcesEditInfo,resourceName:"draft.json"}),this.getItemPublishStatus()!==F.hX.draft){let e=await ek.fetchPublishedItemData(t);this.setItemData(e)}}catch(e){if(e instanceof a.Lf&&e.code===C.ZJ.READ_ONLY_MODE)throw new en.D({type:"read-only-mode"})}},this.isStoryOwner=async()=>{let e=await this.authManager?.getUser();return e?.username===this.itemOwner},this.duplicateStory=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"draft",i=`${(0,u.mZ)(t.config.PORTAL_HOST,t.authManager)}/content/users/${t.itemOwner}/items/${t.itemId}/copy`,s=e instanceof Set?e:new Set([e]),r=s.has("draft"),o=s.has("published"),n=[{mode:"draft",tag:eP.lI.DRAFT},{mode:"published",tag:eP.lI.PUBLISHED},{mode:"from-template",tag:eP.lI.FROM_TEMPLATE},{mode:"to-template",tag:eP.lI.TO_TEMPLATE}].filter(e=>{let{mode:t}=e;return s.has(t)}).map(e=>{let{tag:t}=e;return t}),l=(0,y.c)(t.itemDetails),h=await (0,a.Em)(i,{authentication:t.authManager,params:{includeResources:!0,copyPrivateResources:r,tags:n.join(","),...l?{updateItemType:!0}:{},f:"json"}});L.A.trackEvent(t.isTemplate&&(0,N._E)(t.type)?U[t.type]:k[t.type],t.isTemplate?L.A.Action.Builder_Template:eN[t.type],o?L.A.Name.ItemStatistics_DuplicatePublishedItem:L.A.Name.Builder_Common_Duplicate);let c={itemId:h.itemId,authManager:t.authManager,portalHost:t.config.PORTAL_HOST},p={delay:5e3};if(o)try{if(t.itemDetails&&t.itemDetails.typeKeywords&&t.getItemPublishDate()<new Date(16384032e5))throw Error("Check item data for published data immediately");await (0,m.O$)(eT.$.fetchPublishedItemData,{promiseArguments:[{...c,type:t.type,onlyReturnPublishedDataJsonResource:!0}],...p,maxRetries:12})}catch{await (0,m.O$)(eT.$.fetchPublishedItemData,{promiseArguments:[{...c,type:t.type}],...p,maxRetries:3})}else{let e=await ek.fetchItemDetails(c);await (0,m.O$)(d.hB,{promiseArguments:[{itemDetails:e,portalHost:t.config.PORTAL_HOST,authManager:t.authManager}],...p,maxRetries:60})}return h},this.duplicateStoryCleanup=async e=>{let{titlePrefix:t,untitledItemString:i}=e,a=(0,ev.BT)(this.itemDetails,this.isDraftDataFetchedFromPublishedData),s=a.has("from-template"),r=a.has("to-template");a.has("published")&&await this.discardUnpublishedChanges(!0);let o=s?"":`${t} `;if(this.type===p.z.Theme){let e=await function(e,t){let i=(0,ed.pZ)({stringModifier:t.titlePrefix,originalString:e.title??t.untitledItemString,maxLength:C.s1});return{...e,title:i}}(this.itemDraftData,{untitledItemString:i,titlePrefix:o});this.setItemDraftData(e)}else{let e=await this.authManager?.getUser(),t=function(e){let{itemData:t,coverOptions:i,duplicateMode:a}=e,s=a.has("published");return t.nodes=Object.keys(t.nodes).reduce((e,a)=>{let r=t.nodes[a];if(eA(r)){let t=r;if(s&&(t=function(e){if(!eA)return e;let t=e.config;if(!t?.analytics)return e;let i=structuredClone(t);return delete i.analytics,{...e,config:i}}(t)),"story"===r.type&&(r.config?.allowedTranslations||r.config?.shouldUnlink)){let e=r.config;delete e.allowedTranslations,delete e.shouldUnlink,t={...t,config:e}}return t=function(e,t){if(!eA)return e;let i=e.data;if(!i.metaSettings||"string"!=typeof i.metaSettings.title)return e;let a=structuredClone(i.metaSettings);return a.title=(0,ed.pZ)({stringModifier:t,originalString:i.metaSettings.title,maxLength:ea.r4}),{...e,data:{...i,metaSettings:a}}}(t,i.titlePrefix),{...e,[a]:t}}return eI(r)?{...e,[a]:function(e,t){if(!["storycover","collection-cover"].includes(e.type))return e;let i=e.data,a=i.title,s=(0,eb.Zt)(a)?t.untitledItemString:a,r=(0,ed.pZ)({stringModifier:t.titlePrefix,originalString:s,maxLength:ea.r4}),o=(0,eb.cT)(t.user.firstName,t.user.lastName);return{...e,data:{...i,title:r,byline:o}}}(r,i)}:{...e,[a]:r}},{}),t}({itemData:this.itemDraftData,coverOptions:{untitledItemString:i,titlePrefix:o,user:e},duplicateMode:a});this.setItemDraftData(t)}let n=function(e,t){if("title"in e)return e.title??t;if("nodes"in e)for(let i in e.nodes){let a=e.nodes[i];if(eI(a))return a.data.title??t}return t}(this.itemDraftData,i),l=(0,ee.T)(this.itemDetails);if(l?.metaProperties?.title){let e=structuredClone(l);e.metaProperties?.title&&(e.metaProperties.title=n,l=(0,ee.c)(e,this.itemDetails))}return this.itemDetails.properties?.allowedTranslations&&delete this.itemDetails.properties.allowedTranslations,this.setItemDetails({...this.itemDetails,title:n,properties:l,tags:this.itemDetails.tags?.filter(e=>e!==eP.lI.DRAFT&&e!==eP.lI.PUBLISHED&&e!==eP.lI.TO_TEMPLATE&&e!==eP.lI.FROM_TEMPLATE),typeKeywords:s?this.itemDetails.typeKeywords?.filter(e=>e!==S.Jv):r?[...this.itemDetails.typeKeywords??[],S.Jv]:this.itemDetails.typeKeywords?.filter(e=>!e.includes(S.Z$))}),await this.unpublishStory(!0),a},this.fetchItemResource=async e=>{let{skipEditInfoTracking:t,...i}=e,a=await super.fetchItemResource(i);return t||await _({authManager:this.authManager,config:this.config,itemDetails:this.itemDetails,itemResourcesEditInfo:this.itemResourcesEditInfo,resourceName:i.resourceName}),a},this.getItemFirstPublishDate=()=>this.getItemPublishStatus()===F.hX.published&&super.getItemFirstPublishDate(),this.autosaveStory=(0,m.GR)(this.saveDraft,{debounceTime:1e3,throttleTime:1e4,confirmBeforeUnload:!0,setFnStatusBeforeUnload:()=>this.setPendingChanges,onImmediateCallback:e=>{this.removePristineTypeKeyword(),this.isPublishWorkflowLocked?e("Cancel: pending publish"):this.cancelPendingAutosave=e}}),this.onSaveEnd=(e,t,i)=>{window.removeEventListener("beforeunload",this.defaultWindowUnloadEvent),this.emit("story-save-end",e,t,i),this.setPendingChanges("save",this.pendingChangesKey,!1)},this.getPublishEventName=e=>{switch(e){case 1:return"story-publish";case 3:return"discard-unpublished-changes";default:return"story-unpublish"}},this.onPublishMethodStart=e=>!this.isPublishWorkflowLocked&&!this.isDataRecoveryPendingReview&&(this.cancelPendingAutosave?.("Cancel: Publish method started"),this.isPublishWorkflowLocked=!0,this.emit(`${this.getPublishEventName(e)}-start`),window.addEventListener("beforeunload",this.defaultWindowUnloadEvent),!0),this.onPublishMethodEnd=(e,t)=>{this.isPublishWorkflowLocked=!1,this.emit(`${this.getPublishEventName(e)}-end`,...t),this.emit("publish-method-end"),window.removeEventListener("beforeunload",this.defaultWindowUnloadEvent)},this.onDataOverwriteRejected=()=>{window.removeEventListener("beforeunload",this.defaultWindowUnloadEvent),this.emit("DATA_OVERWRITE_REJECTED")},this.getStoryData=async e=>({itemDetails:{},itemData:{root:"",nodes:{},resources:{}}}),this.generateStoryItemUrl=()=>{throw Error("Generate-url function not provided")},this.emitBeforePublish=e=>Promise.resolve(),this.updateDataAndDetails=async(e,t)=>{let i=t?{itemData:this.itemDraftData,itemDetails:this.itemDetails}:await this.getStoryData(e);if(void 0!==i){if((1===e||0===e)&&this.setItemDraftData(i.itemData),1===e||2===e||this.getItemPublishStatus()===F.hX.draft){let t={...this.itemDetails,...i.itemDetails};t.title||(t.title=(0,ev.x2)({type:this.type,dateStamp:t.created})),this.getItemPublishStatus()===F.hX.draft&&1!==e&&2!==e&&delete i.properties?.allowedTranslations,this.type!==p.z.Theme&&(1===e?t.url=this.generateStoryItemUrl((0,es.WU)({route:"viewer",itemId:this.itemId,itemType:this.type,isTemplate:this.isTemplate})):2===e&&(t.url=""));let a=void 0===i.shouldPushMetaToAGOItemDetails?ei.s:i.shouldPushMetaToAGOItemDetails;if(await e_({type:this.type,itemDetails:t,itemProperties:i.properties,thumbnail:i.thumbnail,baseUrl:this.config.BASE_URL,authManager:this.authManager,portalHost:this.config.PORTAL_HOST,shouldPushMetaToAGOItemDetails:a,shouldForceUpdateThumbnail:i.hasShouldPushMetaToAGOItemDetailsChanged&&a}),a){let e=i.properties?.metaProperties;e?.title&&(t.title=e.title),e?.description&&(t.snippet=e.description),delete i.properties?.metaProperties,delete t.properties?.metaProperties}else delete t.title,delete t.snippet,delete t.description;i.properties&&(t.properties=(0,ee.c)(i.properties,t)),t.clearEmptyFields=!0,this.setItemDetails(t)}}else throw Error("Story data not getting updated.")},this.defaultWindowUnloadEvent=e=>{e.preventDefault(),e.returnValue=""},this.downloadDraftRecoveryFileFromConsole=()=>{eC(this.itemId)||console.error("No draft recovery file available for download.")},this.storeBackup=()=>{try{let e={timestamp:Date.now(),downloaded:!1,data:this.itemDraftData};window.localStorage.setItem(eR(this.itemId),JSON.stringify(e))}catch{}},this.handleDataLossWarning=async e=>{if(e?.editInfo&&"function"==typeof this.confirmDataLoss){if(!await this.confirmDataLoss(e.editInfo))throw this.onDataOverwriteRejected(),Error(ea.mu);this.isDataLossAllowed=!0,setTimeout(()=>{this.isDataLossAllowed=!1},5e3)}},this.removePristineTypeKeyword=()=>{this.itemDetails.typeKeywords?.includes(S.DD)&&this.setItemDetails({...this.itemDetails,typeKeywords:this.itemDetails.typeKeywords.filter(e=>e!==S.DD)})},window.downloadDraftRecoveryFile=this.downloadDraftRecoveryFileFromConsole}get itemDraftData(){return this._itemDraftData}set itemDraftData(e){if(this._itemDraftData)throw Error("Item draft data have already been set on the StoryItem and cannot be modified from outside of the StoryItem");this.setItemDraftData(e)}get itemLastSavedTimestamp(){return this.itemResourcesEditInfo.DRAFT_DATA_RESOURCE?.modified??this.itemDetails.modified}updateAppVersion(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=1===e||2===e?eo.by.published:eo.by.draft,i=(this.itemDetails.typeKeywords??[]).filter(e=>0!==e.search(t));2===e?this.setItemDetails({...this.itemDetails,typeKeywords:i}):this.setItemDetails({...this.itemDetails,typeKeywords:[...i,`${t}:${this.config.APP_VERSION}`]})}setItemPublishStatus(e){let t=H(e,this.itemDetails.typeKeywords??[]);this.setItemDetails({...this.itemDetails,typeKeywords:[...t]})}setItemFirstPublishDate(e){let t=(this.itemDetails.typeKeywords??[]).filter(e=>!e.match(eo.cC.firstPublishedDate));"remove"===e?this.setItemDetails({...this.itemDetails,typeKeywords:[...t]}):this.setItemDetails({...this.itemDetails,typeKeywords:[...this.itemDetails.typeKeywords??[],`${eo.cC.firstPublishedDate}:${new Date(e).getTime()}`]})}setItemDraftData(e){let t=et.CY.sanitize(e,{allowUndefined:!0});this._itemDraftData=t,this.itemDraftDataJSON=JSON.stringify(t)}}let eU=ek},299712:(e,t,i)=>{i.d(t,{g:()=>r,s:()=>s});var a=i(694637);let s=!0,r=(e,t)=>{let i=e.root();e.getAreSocialIconsHidden=()=>e.config.isSocialIconsHidden,e.setAreSocialIconsHidden=t=>{e.config.isSocialIconsHidden=t,e.update()},e.getShouldPushMetaToAGOItemDetails=()=>!1===e.getGlobalStates().featureDecisions.canAccessPortalApp||(e.config.shouldPushMetaToAGOItemDetails??s),e.resetMetaSettings=async()=>{e.data.metaSettings&&(delete e.data.metaSettings,await t.onReset?.(),e.emitMetaSettingsUpdate(),await e.update())},e.emitMetaSettingsUpdate=t=>{let a=t??e.getMetaSettings();i.emit("meta-settings-update",a)},e.getMetaSettings=()=>{let i=t.getMetaThumbnail();return{title:e.data.metaSettings?.title,description:e.data.metaSettings?.description,thumbnail:i}},e.updateMetaSettings=async t=>{t.shouldPushMetaToAGOItemDetails!==e.config.shouldPushMetaToAGOItemDetails&&(e.config.shouldPushMetaToAGOItemDetails=t.shouldPushMetaToAGOItemDetails,e.states.hasShouldPushMetaToAGOItemDetailsChanged=!0);let i={title:t.metaSettings.title??e.data.metaSettings?.title,description:t.metaSettings.description??e.data.metaSettings?.description,thumbnail:t.metaSettings.thumbnail};e.emitMetaSettingsUpdate(i);let s={title:i.title,description:i.description,imageResourceId:e.data.metaSettings?.imageResourceId};if(t.metaThumbnailForUpload){let i,{storyItem:r}=e.getGlobalStates();try{i=await (0,a.QM)({storyBuilder:r,data:t.metaThumbnailForUpload})}catch(t){e.getGlobalStates().toast.add({type:"error",title:e.getGlobalStates().getIntl().formatMessage({id:"builder.common.uploadError"})})}if(i){let t=await e.insertResource({data:{resourceId:i.resourceId,provider:"item-resource",type:"image",width:i.width,height:i.height},root:e,type:"image"});t&&(s.imageResourceId=t.id)}}e.data.metaSettings=s,await e.update()},e.getHaveMetaSettingsChanged=()=>void 0!==e.data.metaSettings?.title||void 0!==e.data.metaSettings?.description||void 0!==e.data.metaSettings?.imageResourceId,e.getMetaSettingsDataForSave=()=>{let t=e.root().do("getCoverData"),i=e.getShouldPushMetaToAGOItemDetails(),a={...!i?{title:t.title,description:t.snippet}:{},...e.data.metaSettings};return a.imageResourceId&&delete a.imageResourceId,{shouldPushMetaToAGOItemDetails:i,hasShouldPushMetaToAGOItemDetailsChanged:e.states.hasShouldPushMetaToAGOItemDetailsChanged,properties:{metaProperties:a}}},i.addEventListener("getMetaSettings",e.getMetaSettings),i.addEventListener("updateMetaSettings",e.updateMetaSettings),i.addEventListener("getHaveMetaSettingsChanged",e.getHaveMetaSettingsChanged),i.addEventListener("resetMetaSettings",e.resetMetaSettings),i.addEventListener("getShouldPushMetaToAGOItemDetails",e.getShouldPushMetaToAGOItemDetails),i.addEventListener("isSocialIconsHidden",e.getAreSocialIconsHidden),i.addEventListener("updateSocialIconsHiddenStatus",e.setAreSocialIconsHidden)}},331366:(e,t,i)=>{i.d(t,{$:()=>I,A:()=>w});var a=i(535978),s=i(647682),r=i(777011),o=i(230658),n=i(960642),l=i(989206),d=i(789016),h=i(387189),u=i(104471),c=i(647345),m=i(325247),p=i(142529),y=i(602422),f=i(34863),g=i(443394),S=i(54302),D=i(226453),b=i(270350),A=i(385526);class I extends a.EventEmitter{static #e=this.validateItemData=(e,t)=>{switch(e){case o.z.Briefing:case o.z.Collection:case o.z.Frame:case o.z.Story:return t&&"string"==typeof t.root;case o.z.Theme:return t&&"object"==typeof t;default:return!1}};static #t=this.fetchItemDetails=async e=>{let t=e.authManager?e.authManager:void 0;return await (0,s.Gq)(e.itemId,{authentication:t,portal:t?void 0:(0,n.mZ)(e.portalHost),signal:e.signal})};static #i=this.fetchPublishedItemData=async e=>{let t=await (0,l.e)({itemId:e.itemId,authManager:e.authManager,portalHost:e.portalHost,language:e.language,onlyReturnPublishedDataJsonResource:e.onlyReturnPublishedDataJsonResource,signal:e.signal,timeStamp:e.timeStamp});if(t=await (0,A.eq)(e,t),I.validateItemData(e.type,t))return t;let i=Error(`invalid json response body at ${(0,n.mZ)(e.portalHost,e.authManager)}/content/items/${e.itemId}/data. reason: Unexpected end of JSON input`);throw i.name="FetchError",i.type="invalid-json",i};constructor(e){var t;super(),t=this,this._isOrgItem=!1,this._viewerMode="view",this.preloadedItemResourceImages={},this._isTemplate=!1,this.getItemResourceUrl=(e,t)=>{let i=e.authManager||this.authManager,a=this.shouldItemResourceUseCDN(),s=e.queryParameters?Object.assign({},e.queryParameters):{};!e.skipToken&&!a&&i&&i.token&&(s.token=i.token);let r=`${e.sharingUrl??(0,n.mZ)(this.config.PORTAL_HOST)}/content/items/${t??this.itemId}/resources/${e.resourceName}${Object.keys(s).length?"?"+(0,d.lK)(s):""}`;return a&&(r=r.replace(/^https:\/\/www\.arcgis\.com/,"https://cdn.arcgis.com")),r},this.preloadItemResourceImage=(e,t)=>{let i=this.getKeyForPreloadedItemResourceImage(e,t);return new Promise(a=>{if(void 0!==this.preloadedItemResourceImages[i])a({image:this.preloadedItemResourceImages[i],key:i,fileName:e,width:t});else{let s=new Image;s.src=this.getItemResourceImageFullUrl({imageFileName:e,width:t}),s.onload=()=>{this.preloadedItemResourceImages[i]=s,a({image:s,key:i,fileName:e,width:t})},s.onerror=i=>{a({error:i.error,fileName:e,width:t})}}})},this.getSupportedTranslationLocales=()=>Object.keys((0,h.T)(this.itemDetails)?.translations??{}),this.getOriginalStoryLocale=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"en-us";return t.itemDetails.culture??e},this.getKeyForPreloadedItemResourceImage=(e,t)=>`${e}_w${t}`,this._fetchItemResource=async e=>{let t=this.getItemResourceUrl({...e,skipToken:!0}),i=await (0,r.Em)(t,{authentication:this.authManager,httpMethod:"GET"});return/\.json$/.test(e.resourceName)?u.CY.sanitize(i,{allowUndefined:!0}):i},this._type=e.type,this.config=e.config,this.version=e.version,e.authManager&&(this.authManager=e.authManager),this._getStoryMapUserPrivileges=e.getStoryMapUserPrivileges,e.viewerMode&&(this.viewerMode=e.viewerMode)}get isTemplate(){return this._isTemplate}get itemId(){return this._itemId}set itemId(e){this._itemId||(this._itemId=e)}get type(){return this._type}get itemOwner(){return this._itemOwner}get itemDetails(){return this._itemDetails}set itemDetails(e){if(this._itemDetails)throw Error("Item details have already been set on the StoryItem and cannot be modified from outside of the StoryItem");this.setItemDetails((0,c.if)(e)?(0,c.Nr)(e):e)}get itemData(){return this._itemData}set itemData(e){if(this._itemData)throw Error("Item data have already been set on the StoryItem and cannot be modified from outside of the StoryItem");this.setItemData(e)}get itemSharingLevel(){return this._itemSharingLevel?this._itemSharingLevel.access===m.uQ.PRIVATE&&this._itemSharingLevel.groups?.length&&this._itemSharingLevel.groups?.length>0?{access:m.uQ.SHARED,groups:this._itemSharingLevel.groups,isUnlisted:!1}:this._itemSharingLevel:this.itemDetails&&this.itemDetails.access?{access:this.itemDetails.access,groups:[],isUnlisted:this.itemDetails.typeKeywords?.includes(p.aE)??!1}:D.s}set itemSharingLevel(e){this._itemSharingLevel=e}get selectedTopicTagIds(){let e=(0,c.Ad)(this.itemDetails);return JSON.stringify(e)!==JSON.stringify(this._selectedTopicTagIds)&&(this._selectedTopicTagIds=e),this._selectedTopicTagIds}set version(e){this._itemVersion=e}get version(){return this._itemVersion}get isOrgItem(){return this._isOrgItem}set viewerMode(e){this._viewerMode=e}get viewerMode(){return this._viewerMode}get authManager(){return this._authManager}set authManager(e){!this.itemOwner&&e&&e.username&&(this._itemOwner=e.username),this._authManager=e}get storyMapUserPrivileges(){return this._getStoryMapUserPrivileges()}getItemPublishDate(){try{let e=(0,y.cW)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:b.cC.publishedDate})[0]||(0,y.cW)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:"publish-date"})[0];if(e)return new Date(parseInt(e,10));throw Error("No published date")}catch{if("builder"===this.viewerMode)return!1;return new Date(this.itemDetails?this.itemDetails.created:Date.now())}}getItemFirstPublishDate(){try{let e=(0,y.cW)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:b.cC.firstPublishedDate})[0];if(e)return new Date(parseInt(e,10));throw Error("No first published date")}catch{if("builder"===this.viewerMode)return!1;return new Date(this.itemDetails?this.itemDetails.created:Date.now())}}getItemPublishStatus(){return void 0===this.itemDetails?f.hX.draft:(0,c.$l)(this.itemDetails)||f.hX.draft}getItemResourceImageFullUrl(e){let{imageFileName:t,width:i,itemId:a,shouldIgnoreDPR:s,sharingUrl:r}=e;if(!t)return"";if(t.startsWith("https://"))return t;let o=i&&(0,g.C)({width:i,fileName:t,shouldIgnoreDPR:s});return this.getItemResourceUrl({resourceName:t,authManager:void 0,sharingUrl:r,queryParameters:o?{w:o}:void 0},a)}unloadPreloadedItemResourceImage(e,t){delete this.preloadedItemResourceImages[this.getKeyForPreloadedItemResourceImage(e,t)]}shouldItemResourceUseCDN(){return"view"===this.viewerMode&&"www.arcgis.com"===this.config.PORTAL_HOST&&this.itemSharingLevel.access===m.uQ.PUBLIC}fetchItemResource(e){return this._fetchItemResource(e)}setItemDetails(e){this._itemId=e.id,this._itemOwner=e.owner,this._isTemplate=(0,c.WE)(e),this._itemDetails=e,(0,S.Eu)(this._itemDetails)&&(this._isOrgItem=!0)}setItemData(e){let t=u.CY.sanitize(e,{allowUndefined:!0});this._itemData=t}}let w=I},375603:(e,t,i)=>{i.d(t,{F4:()=>u,VG:()=>d,hB:()=>c});var a=i(647682),s=i(54302),r=i(960642),o=i(142529),n=i(647345),l=i(602422);let d=e=>/^draft(?:_\d+)?.json$/.test(e),h=e=>(0,l.cW)({typeKeywords:e.typeKeywords,typeKeywordId:o.Fc})[0]||"draft.json",u=e=>e.filter(e=>d(e.resource)).sort((e,t)=>{let i=RegExp(`${o.xq}(?<timestamp>[0-9]+).json`,"g"),a=RegExp(`${o.xq}(?<timestamp>[0-9]+).json`,"g"),s=i.exec(e.resource)?.groups?.timestamp,r=a.exec(t.resource)?.groups?.timestamp;return void 0===s?1:void 0===r?-1:Number(r)-Number(s)}),c=async e=>{let{itemDetails:t,...i}=e;try{let a=h(t);return await (0,s.aK)({...i,itemId:e.itemDetails.id,resourceId:a,httpMethod:"POST"})}catch(o){if((0,n.NJ)(t))return{...await (0,a.MB)(e.itemDetails.id,{authentication:e.authManager}),title:t.title,snippet:t.snippet};for(let t of u(await (0,s.EY)({authManager:e.authManager,username:e.itemDetails.owner,itemId:e.itemDetails.id,portal:(0,r.mZ)(e.portalHost,e.authManager)})))try{return await (0,s.aK)({...i,itemId:e.itemDetails.id,resourceId:t.resource,httpMethod:"POST"})}catch{}throw o}}},425233:(e,t,i)=>{i.d(t,{CN:()=>o,by:()=>r,cC:()=>s,uB:()=>a});var a=function(e){return e[e.DRAFT_SAVE=0]="DRAFT_SAVE",e[e.PUBLISHING=1]="PUBLISHING",e[e.UNPUBLISHING=2]="UNPUBLISHING",e[e.DISCARDING_UNPUBLISHED_CHANGES=3]="DISCARDING_UNPUBLISHED_CHANGES",e}({}),s=function(e){return e.publishedDate="smpublisheddate",e.firstPublishedDate="smfirstpublisheddate",e.hasTranslation="smtranslated",e}({}),r=function(e){return e.published="smversionpublished",e.draft="smversiondraft",e}({}),o=function(e){return e.DRAFT="draft",e.PUBLISHED="published",e}({})},504368:(e,t,i)=>{i.d(t,{$V:()=>c,Lc:()=>p,Rs:()=>u,XH:()=>d,b0:()=>h});var a=i(647682),s=i(777011),r=i(142529),o=i(34863),n=i(802515),l=i(620538);let d=async e=>{let t,{customSearchOptions:i,searchParams:s,...r}=e;s&&(r.params=s);let o=(t=i&&"groupItems"===i.searchType?await m(i.groupId,r):await (0,a.Ds)(r)).results;if(e.authentication&&o.length>0){let i=(await e.authentication.getUser()).favGroupId,s=o.reduce((e,t,i)=>`${e} ${0===i?`AND id:("${t.id}"`:`OR "${t.id}"`}${i===o.length-1?"))":""}`,`(group:"${i}"`),r=await (0,a.Ds)({authentication:e.authentication,q:s,params:{num:o.length}}),n=o.map(e=>({...e,isFavorite:r.results.findIndex(t=>t.id===e.id)>=0}));return{...t,results:n}}return t};var h=function(e){return e[e.stories=0]="stories",e[e.apps=1]="apps",e[e.files=2]="files",e[e.maps=3]="maps",e[e.webmaps=4]="webmaps",e[e.mobilePackages=5]="mobilePackages",e[e.featureLayers=6]="featureLayers",e[e.collections=7]="collections",e[e.briefings=8]="briefings",e}({});let u=async(e,t,i)=>{if(i)return;let a=await (0,n.Tb)(e,t);return a&&"WO"!==a?`/Region/WO,/Region/${a}`:"/Region/WO"},c=e=>{let t=" NOT access:private",i={0:`("${r.tm}" AND typekeywords:("${o.hX.published}" OR "${o.hX.unpublishedChanges}") NOT typekeywords:(${r.nt} OR ${r.iz} OR ${r.FW} OR ${r.Jv}))`,1:`("${o.J6.WebApp}" OR "${o.J6.Dashboard}" OR "${o.J6.WebExperience}" OR "${o.J6.InsightsPage}" OR "${o.J6.HubSiteApp}" OR "${o.J6.EnterpriseSiteApp}" OR "${o.J6.Survey123}"${t})`,2:`("${o.J6.Image}" OR "${o.J6.PDF}"${t})`,3:`("Web Map" OR type:"Web Scene" -type:"${r.tm}" -type:"${o.J6.WebApp}" -type:"CityEngine Web Scene")`,4:`"Web Map" -type:"${r.tm}" -type:"${o.J6.WebApp}" -type:"CityEngine Web Scene"`,5:'"Mobile Map Package" OR "Mobile Scene Package"',6:'"Feature Service" -typekeywords:"Table"',7:`("${r.tm}" AND typekeywords:(${r.nt}) AND typekeywords:("${o.hX.published}" OR "${o.hX.unpublishedChanges}") NOT typekeywords:(${r.Jv} OR ${r.iz} OR ${r.FW}))`,8:`("${r.tm}" AND typekeywords:(${r.FW}) AND typekeywords:("${o.hX.published}" OR "${o.hX.unpublishedChanges}") NOT typekeywords:(${r.Jv} OR ${r.iz} OR ${r.nt}))`};return"type:("+[].concat(e).map(e=>`${i[e]}`).join(" OR ")+")"},m=(e,t)=>{let i=Object.keys(t).filter(e=>"authentication"!==e&&"params"!==e),r=(0,s.Oq)(t,i,{httpMethod:"GET"}),o=`${(0,a.e1)(r)}/content/groups/${e}/search`;if(r?.params?.paramStrArr){let e=Object.keys(r.params).reduce((e,t)=>{if(r.params[t]||"boolean"==typeof r.params[t]){let i="paramStrArr"===t?r.params[t].join("&"):`${t}=${r.params[t]}`;return e?`${e}&${i}`:`${i}`}return e},""),t={...r.authentication};return(0,s.Em)(`${o}?${e}`,{...t}).then(e=>e)}return(0,s.Em)(o,r).then(i=>(i.nextStart&&-1!==i.nextStart&&(i.nextPage=()=>m(e,Object.assign({},t,{start:i.nextStart}))),i))},p=e=>{let t="string"==typeof e.filter?new l.q(e.filter):e.filter;return e.showUnlisted||t.and().startGroup().not().matchTypeKeywords(r.aE).endGroup(),(0,a.Ds)({...e,q:e.query??"",filter:t.toParam()})}},611179:(e,t,i)=>{i.d(t,{E2:()=>d,Hv:()=>l,IQ:()=>h});var a=i(177003),s=i.n(a),r=i(54302),o=i(960642),n=i(375603);let l=e=>{let{currentProps:t,newProps:i}=e;return s()({},t,i)},d="DRAFT_DATA_RESOURCE",h=async e=>{let t,{resourceName:i,itemId:a,itemOwner:s,authManager:l,portalHost:h}=e,u=await (0,r.EY)({authManager:l,username:s,itemId:a,portal:(0,o.mZ)(h,l)});return t=i===d?(0,n.F4)(u)[0]:u.filter(e=>e.resource===i)[0],t?.properties&&JSON.parse(t?.properties)||null}},623329:(e,t,i)=>{i.d(t,{p:()=>s,w:()=>a});class a extends Error{constructor(e,t){super("Draft data is missing"),this.itemId=e,t&&(this.recoveryDraftData=t)}getRecoveryDataForDownload(){if(this.recoveryDraftData)return`data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(this.recoveryDraftData))}`}}let s=e=>e instanceof a&&!!e.recoveryDraftData},694637:(e,t,i)=>{i.d(t,{$v:()=>S,EA:()=>g,O1:()=>A,QM:()=>f,R4:()=>c,bj:()=>I,fd:()=>u,hm:()=>h,td:()=>w,vH:()=>p});var a=i(342211),s=i(462829),r=i(231879),o=i(34863),n=i(137373),l=i(777142),d=i(270350);let h=async e=>{let t,{blob:i,fileType:a,config:r,disallowedMimeTypes:o}=e;if(a===d.O2.Audio||a===d.O2.Video||a===d.O2.ImageOrVideo||a===d.O2.Image360||a===d.O2.Image)if(r)t=await p({blob:i,fileType:a,config:r,disallowedMimeTypes:o});else throw Error("Config cannot be undefined");else t=await p({blob:i,fileType:a});if(!t.isValid)throw t.details;return a===d.O2.GeoData?await y(i):await (0,s.aO)(i)},u=async(e,t)=>{let i=t?await (0,s.ti)(t):void 0,a=i?.ext,o=["heic","heif","webp","tiff","tif"].includes(a??""),n=t&&a?.match(/(jpg|jpeg|heic|heif|webp|tiff|tif)$/i)?await D(t):void 0;if(o)return{src:e,width:0,height:0,provider:"uri",location:n};try{let{width:t,height:i}=await (0,r.vX)(e);return{src:e,width:t,height:i,provider:"uri",location:n}}catch(e){throw Error(e)}},c=e=>{let{config:t,imageWidth:i,imageHeight:a,fileType:s}=e;if(s?.mime&&t?.SUPPORTED_COMPRESSIBLE_IMAGE_MIME_TYPES.includes(s.mime)){if(i>l.YM||a>l.YM)throw o.CF.INVALID_IMAGE_COMPRESSIBLE}else if(i>l.r1||a>l.r1)throw o.CF.MAX_FILE_SIZE_EXCEEDED},m=async e=>{let{blob:t,validMimeTypes:i,checkFileExtensionOnly:a}=e;if(a)return A(t.name,i).length>0;let r=await (0,s.ti)(t);if(!r)return!1;let{mime:o}=r;return!!i.find(e=>o===e)},p=async e=>{let t,{blob:i,fileType:a,config:s,disallowedMimeTypes:r}=e,h=[],u=[],c=[],p=[];switch((a===d.O2.Video||a===d.O2.Audio||a===d.O2.ImageOrVideo||a===d.O2.Image360||a===d.O2.Image)&&void 0!==s&&(h=(0,n.Yn)(d.O2.Video,s,r),u=(0,n.Yn)(d.O2.Audio,s,r),c=(0,n.Yn)(d.O2.Image,s,r),p=(0,n.Yn)(d.O2.Image360,s,r)),a){case d.O2.Image:t=c;break;case d.O2.Image360:t=p;break;case d.O2.Video:t=h;break;case d.O2.Audio:t=u;break;case d.O2.ImageOrVideo:t=[...c,...h];break;case d.O2.File:t=l.pp;break;case d.O2.GeoData:t=l.X0;break;default:return{isValid:!1,details:o.CF.INVALID_FILE_TYPE}}let y=await m({blob:i,validMimeTypes:t,checkFileExtensionOnly:a===d.O2.GeoData}),f=a;y&&a===d.O2.ImageOrVideo&&(f=-1!==h.findIndex(e=>e===i.type)?d.O2.Video:d.O2.Image);let g="image/gif"===i.type||"application/pdf"===i.type||"text/vtt"===i.type||f===d.O2.Video||f===d.O2.Audio?i.size>l.w3:f===d.O2.GeoData?i.size>l.B0:f===d.O2.Image360?i.size>l.iN:i.size>l.WP,S=!1,D=!1;f===d.O2.Image&&s?.SUPPORTED_COMPRESSIBLE_IMAGE_MIME_TYPES&&(D=await m({blob:i,validMimeTypes:s.SUPPORTED_COMPRESSIBLE_IMAGE_MIME_TYPES,checkFileExtensionOnly:!1}),S=i.size<l.w3&&D);let b=y&&(!g||S),A="";return y?g&&!D?A=o.CF.MAX_FILE_SIZE_EXCEEDED:D&&(A=o.CF.INVALID_IMAGE_COMPRESSIBLE):A=o.CF.INVALID_FILE_TYPE,{isValid:b,details:A}},y=async e=>{let t;try{t=await e.text()}catch{throw o.CF.FILE_READ_ERROR}if(t?.length)return t;throw o.CF.FILE_READ_ERROR},f=e=>new Promise((t,i)=>{let a=e.blob||(0,s.zM)(e.data.src),r=g(a.type);e.storyBuilder.upsertItemResource({resourceName:r,resource:a,isAdd:!0}).then(()=>{let i={provider:"item-resource",resourceId:r};e.data.width&&(i.width=e.data.width),e.data.height&&(i.height=e.data.height),e.data.name&&(i.name=e.data.name),t(i)}).catch(()=>{i()})}),g=e=>{let t=e.slice(e.indexOf("/")+1);return"svg+xml"===t&&(t="svg"),S(t)},S=e=>`${(0,a.Ak)()}.${e}`,D=async e=>{try{await Promise.all([i.e(51642),i.e(33506)]).then(i.bind(i,733506));let t=await Promise.all([i.e(51642),i.e(20915)]).then(i.t.bind(i,120915,23)),a=await t.gps(e);if(a?.latitude&&a?.longitude)return{latitude:a.latitude,longitude:a.longitude};return}catch(e){return}},b=e=>RegExp(`\\.${e}$`,"i"),A=(e,t)=>{for(let i of t){let t=b(i);if(e.match(t))return i}return""},I=async e=>{let t=await (0,s.ti)(e),a=-1!==l.Wr.findIndex(e=>e===t?.mime),r=e.size>l.iN;if(!a||r)throw o.CF.INVALID_360_IMAGE;await Promise.all([i.e(51642),i.e(33506)]).then(i.bind(i,733506));let n=await Promise.all([i.e(51642),i.e(17203),i.e(4828)]).then(i.bind(i,217203)),d=await n.parse(e,{xmp:!0}),h=await (0,s.aO)(e),c=await u(h,e);if(d?.ProjectionType!=="equirectangular"){let e=c.width/c.height;if(e>=1.5&&e<=3)return c;throw o.CF.INVALID_360_IMAGE}return{...c,projectionType:"equirectangular"}},w=async(e,t,i,a)=>{if(e===d.O2.Image){let e=!0;if(l.gC.includes(t))try{let t=await h({blob:a,fileType:d.O2.Image,config:i}),{width:s,height:o}=await (0,r.vX)(t);e=(s>l.r1||o>l.r1)&&s<l.YM&&o<l.YM}catch(t){e=!1}let s=a.size>l.WP&&a.size<l.w3;return(e||s)&&(i.SUPPORTED_COMPRESSIBLE_IMAGE_MIME_TYPES.includes(t)||i.SUPPORTED_CONVERTIBLE_IMAGE_MIME_TYPES.includes(t))}return e===d.O2.GeoData||(e===d.O2.Audio?i.SUPPORTED_CONVERTIBLE_AUDIO_MIME_TYPES.includes(t):i.SUPPORTED_CONVERTIBLE_VIDEO_MIME_TYPES.includes(t))}},812160:(e,t,i)=>{i.d(t,{I:()=>s,R:()=>r});var a=i(647682);let s=e=>{let{group:t,hasItemOwnerPermission:i,allowSharingToUpdateGroups:a}=e;return!!((t.userMembership?.memberType==="admin"||t.userMembership?.memberType==="owner"||!t.isViewOnly&&t.userMembership?.memberType==="member"&&i)&&(!a&&(!t.capabilities||!t.capabilities.includes("updateitemcontrol"))||a))},r=async(e,t)=>(await (0,a.tp)(e,{authentication:t,paging:{num:100,start:0},httpMethod:"GET"})).items.reduce((e,t)=>(e.push(t.id),e),[])},888308:(e,t,i)=>{i.d(t,{H:()=>r,c:()=>s});var a=i(142529);let s=e=>e.type!==a.tm&&e.type!==a.Jk&&[...a.tQ,...a.vw].includes(e.type),r=e=>e.type===a.tm&&"SMX Item"!==e.type&&!!e?.typeKeywords?.includes("SMX Item")},989206:(e,t,i)=>{i.d(t,{J:()=>o,e:()=>n});var a=i(647682),s=i(960642),r=i(54302);let o="published_data.json",n=async e=>{let{itemId:t,authManager:i,portalHost:n,language:l,onlyReturnPublishedDataJsonResource:d,signal:h,timeStamp:u}=e,c=i?void 0:(0,s.mZ)(n);try{let e=u?`?ts=${u}`:"";return await (0,r.aK)({itemId:t,resourceId:l?`published_data_${l}.json`:`${o}${e}`,portalHost:n,authManager:i,signal:h})}catch{if(!d)return await (0,a.MB)(t,{authentication:i,portal:c,signal:h})}}}}]);